name: Packer CI - Format & Validate

on:
  pull_request:
    branches:
      - main  # Trigger the workflow only for PRs targeting the 'main' branch

jobs:
  packer-checks:
    runs-on: ubuntu-latest  # Use an Ubuntu environment for the CI workflow

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4  # Checks out the latest code from the repository

      # Step 2: Install Java and Maven
      - name: Set Up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      # Step 3: Build the JAR file (HealthCheck-0.0.1-SNAPSHOT.jar)
      - name: Build the HealthCheck JAR file
        run: |
          cd ../HealthCheck  # Navigate to the directory containing your Spring Boot app
          mvn clean install  # Build the JAR file (ensure your pom.xml is correctly configured)
        working-directory: HealthCheck  # Navigate to the 'HealthCheck' directory before running the command

      # Step 4: Install Packer
      - name: Install Packer
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -  # Add Packer GPG key
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"  # Add Packer repository
          sudo apt update && sudo apt install -y packer  # Install Packer

      # Step 5: Initialize the Packer template
      - name: Initialize Packer Template
        run: |
          packer init packer.pkr.hcl
        working-directory: packer
      # Step 6: Run packer fmt to check formatting
      - name: Run Packer Format Check
        run: |
          packer fmt -check .  # Checks if the Packer template is correctly formatted. If modified, it fails
        working-directory: packer  # Navigate to the 'packer' directory before running the command

      # Step 7: Run packer validate to validate the Packer template
      - name: Run Packer Validate
        run: |
          packer validate \
            -var "DB_URL=${{ secrets.DB_URL }}" \
            -var "DB_USRNAME=${{ secrets.DB_USRNAME }}" \
            -var "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            -var "DB_NAME=${{ secrets.DB_NAME }}" \
            -var "subnet_id=${{ secrets.subnet_id }}" \
            -var "instance_type=${{ secrets.instance_type }}" \
            -var "PRT_NBR=${{ secrets.PRT_NBR }}" \
            -var "gcp_project_id=${{ secrets.gcp_project_id }}" \
            packer.pkr.hcl    # Validates the Packer template. If it fails, the workflow fails
        working-directory: packer  # Navigate to the 'packer' directory before running the command